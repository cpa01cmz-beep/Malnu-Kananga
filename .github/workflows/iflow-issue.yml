name: "iFlow - Solve Highest Priority Issue"

on:
  schedule:
    # Run every 30 minutes to check for highest priority issues
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      manual_issue_number:
        description: 'Optional: manually specify an issue number to process (ignores priority selection)'
        required: false
        type: number

jobs:
  solve_highest_priority_issue:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
      id-token: write
      repository-projects: write
      checks: write
      discussions: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Select highest priority issue
        id: select_issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          # Manual override via workflow_dispatch
          if [[ "${{ github.event.inputs.manual_issue_number }}" != "" ]]; then
            ISSUE_NUMBER="${{ github.event.inputs.manual_issue_number }}"
            echo "MANUAL_OVERRIDE=true" >> "$GITHUB_ENV"
            echo "Selected issue via manual input: $ISSUE_NUMBER" >> "$GITHUB_STEP_SUMMARY"
          else
            # Fetch all open issues sorted by priority (p0, p1, p2, p3 - highest first)
            echo "Fetching open issues sorted by priority..."
            
            # Get all open issues with priority labels
            issues=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $labels: [String!]) {
                repository(owner: $owner, name: $repo) {
                  issues(first: 100, states: OPEN, labels: $labels) {
                    nodes {
                      number
                      title
                      labels(first: 10) {
                        nodes {
                          name
                        }
                      }
                    }
                  }
                }
              }
            ' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" -f labels="priority/p0,priority/p1,priority/p2,priority/p3" --jq '.data.repository.issues.nodes[] | "\(.number),\(.title),\(.labels.nodes[].name // "no-priority" | select(. | startswith("priority/p")))"' || true)
            
            if [[ -z "$issues" ]]; then
              echo "No issues with priority labels found, checking all open issues..."
              # Get all open issues without requiring priority labels
              issues=$(gh api graphql -f query='
                query($owner: String!, $repo: String!, $labels: [String!]) {
                  repository(owner: $owner, name: $repo) {
                    issues(first: 100, states: OPEN) {
                      nodes {
                        number
                        title
                        labels(first: 10) {
                          nodes {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              ' -f owner="${{ github.repository_owner }}" -f repo="${{ github.event.repository.name }}" --jq '.data.repository.issues.nodes[] | "\(.number),\(.title),\(.labels.nodes[].name // "no-priority" | select(. | startswith("priority/p")) // "no-priority")"' || true)
            fi
            
            if [[ -z "$issues" ]]; then
              echo "No open issues found in the repository"
              echo "SKIP_WORKFLOW=true" >> "$GITHUB_ENV"
              exit 0
            fi
            
            # Create a temporary file to sort issues by priority
            temp_file=$(mktemp)
            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                number=$(echo "$line" | cut -d',' -f1)
                title=$(echo "$line" | cut -d',' -f2)
                priority=$(echo "$line" | cut -d',' -f3)
                
                # Map priority to numeric value for sorting (p0=0, p1=1, p2=2, p3=3, no-priority=4)
                case "$priority" in
                  "priority/p0") priority_val=0 ;;
                  "priority/p1") priority_val=1 ;;
                  "priority/p2") priority_val=2 ;;
                  "priority/p3") priority_val=3 ;;
                  *) priority_val=4 ;;
                esac
                
                echo "$priority_val,$number,$title,$priority" >> "$temp_file"
              fi
            done <<< "$issues"
            
            # Sort by priority (ascending, so lowest number is highest priority)
            sorted_issues=$(sort -t',' -k1,1n "$temp_file")
            
            # Get the highest priority issue (first in sorted list)
            first_issue=$(echo "$sorted_issues" | head -n1)
            if [[ -n "$first_issue" ]]; then
              ISSUE_NUMBER=$(echo "$first_issue" | cut -d',' -f2)
              ISSUE_TITLE=$(echo "$first_issue" | cut -d',' -f3)
              ISSUE_PRIORITY=$(echo "$first_issue" | cut -d',' -f4)
              
              echo "Selected highest priority issue: #$ISSUE_NUMBER ($ISSUE_PRIORITY) - $ISSUE_TITLE"
              echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> "$GITHUB_ENV"
              echo "ISSUE_TITLE=$ISSUE_TITLE" >> "$GITHUB_ENV"
              echo "ISSUE_PRIORITY=$ISSUE_PRIORITY" >> "$GITHUB_ENV"
              echo "Selected highest priority issue: #$ISSUE_NUMBER ($ISSUE_PRIORITY) - $ISSUE_TITLE" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "No issues found to process"
              echo "SKIP_WORKFLOW=true" >> "$GITHUB_ENV"
              exit 0
            fi
            
            rm "$temp_file"
          fi

      - name: Get issue details
        if: env.SKIP_WORKFLOW != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail
          
          data=$(gh api repos/${{ github.repository }}/issues/${{ env.ISSUE_NUMBER }})
          title=$(jq -r '.title // "manual"' <<<"$data")
          body=$(jq -r '.body // ""' <<<"$data")

          {
            echo "ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}"
            echo "REPOSITORY=${{ github.repository }}"
            echo "ISSUE_TITLE<<__EOF__"
            echo "$title"
            echo "__EOF__"
            echo "ISSUE_BODY<<__EOF__"
            echo "$body"
            echo "__EOF__"
          } >> "$GITHUB_ENV"

      - name: Solve Issue
        if: env.SKIP_WORKFLOW != 'true'
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
          ISSUE_BODY: ${{ env.ISSUE_BODY }}
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
          REPOSITORY: ${{ env.REPOSITORY }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Persona
            You are an Autonomous AI Software Engineer. Your mission is to resolve GitHub issues from end-to-end by understanding the problem, investigating the codebase, formulating a plan, implementing a solution, writing tests, and opening a pull request.

            ## Context
            - ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
            - ISSUE_BODY: ${{ env.ISSUE_BODY }}
            - ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
            - REPOSITORY: ${{ env.REPOSITORY }}

            ## Primary Objective
            Autonomously understand, solve, test, and submit a pull request for the given issue. If no code change is needed, triage and close the issue appropriately.

            ## Step-by-Step Workflow
            1.  **Triage and Initial Planning:**
                - First, post a comment on the issue to acknowledge you are starting work: `Working on the highest priority issue.`
                - Analyze the issue title and body.
                - Apply appropriate labels (`bug`, `enhancement`, `documentation`) and remove `status/needs-triage`. Add `status/in-progress`.

            2.  **Code Investigation (CRITICAL STEP):**
                - Before writing any code, you MUST investigate the repository.
                - Use file system and search tools to identify the relevant files, functions, and code sections related to the issue.
                - Understand the existing logic and architecture. This step is essential for creating an effective plan.

            3.  **Develop and Announce Plan:**
                - Based on your investigation, formulate a detailed plan of action.
                - Post a new comment on the issue outlining your plan: "Here is my plan: 
                    1. Modify function `X` in `file.py`. 
                    2. Add a new test case in `tests/test_file.py`. 
                    3. Update the `README.md` with the new behavior."

            4.  **Implementation:**
                - Create a new branch: `git checkout -b iflow/issue-${ISSUE_NUMBER}`
                - Apply the code changes as described in your plan.
                - **Focus on small, atomic changes.** Do not refactor unrelated code.

            5.  **Testing:**
                - **You must add or update tests.**
                - Identify the project's testing framework (e.g., Jest, Pytest, GoTest).
                - Add new unit or integration tests that validate your fix and cover edge cases.
                - Run the entire test suite to ensure your changes have not caused any regressions.

            6.  **Commit and Push:**
                - Commit your changes with a conventional commit message: `git commit -am "fix: [short summary of fix] | Closes #${ISSUE_NUMBER}"`
                - Push the branch to the repository: `git push --set-upstream origin iflow/issue-${ISSUE_NUMBER}`

            7.  **Create Pull Request:**
                - Create a pull request using `gh pr create`.
                - **Title:** `fix: [short summary of fix]`
                - **Body:** The PR body MUST be descriptive. It should contain:
                  - A link to the original issue (e.g., `Closes #${ISSUE_NUMBER}`).
                  - A "Problem" section explaining the issue.
                  - A "Solution" section explaining your changes.
                  - A "Testing" section describing the tests you added or updated.

            8.  **Final Reporting:**
                - Post a final comment on the original issue with a link to the newly created pull request.
                - Update the issue label from `status/in-progress` to `status/review`.

            ## Error Handling
            - If any step fails (especially testing), stop, revert all local changes (`git reset --hard`), and post a comment on the issue explaining the failure and why you are stopping.

            ## Strict Rules
            - **Investigate First:** Never write code without first understanding the relevant parts of the codebase.
            - **Test Your Work:** Code without tests is incomplete. You must provide tests.
            - **Conventional Commits:** All commit messages and PR titles must follow the conventional commit format.
            - **Stay Focused:** Only implement changes related to the issue.
            - **Security:** Never log, print, or commit secrets or sensitive information.