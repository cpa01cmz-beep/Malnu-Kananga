---
name: OC-01
on:
  workflow_dispatch:
  pull_request:
  issues:
  push:

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

concurrency:
  group: global1
  cancel-in-progress: false

jobs:
  analyze:
    name: OC-01
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_KEY }}

    steps:
      - name: Wait in Queue
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 30
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.opencode
          key: opencode-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            opencode-${{ runner.os }}-

      - name: Configure Git
        run: |
          git config --global user.name "analyzer"
          git config --global user.email "analyzer@sanaabililhuda.com"

      - name: Install OpenCode
        run: |
          max_retries=3
          retry_count=0
          install_script=$(mktemp)

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries to install OpenCode"

            if curl -fsSL --retry 3 --retry-delay 5 --connect-timeout 30 --max-time 300 https://opencode.ai/install -o "$install_script"; then
              if [ -s "$install_script" ]; then
                if head -n 1 "$install_script" | grep -q "#!/"; then
                  echo "OpenCode installation script downloaded successfully"
                  chmod +x "$install_script"
                  "$install_script"
                  echo "$HOME/.opencode/bin" >> $GITHUB_PATH
                  rm -f "$install_script"
                  echo "OpenCode installation completed"
                  exit 0
                else
                  echo "Downloaded file is not a valid shell script"
                fi
              else
                echo "Downloaded file is empty"
              fi
            else
              echo "Failed to download OpenCode installation script"
            fi

            retry_count=$((retry_count + 1))
            rm -f "$install_script"

            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((retry_count * 10))
              echo "Retrying in ${wait_time} seconds..."
              sleep $wait_time
            fi
          done

          echo "All OpenCode installation attempts failed"
          exit 1

      - name: Merge
        run: |
          max_retries=2
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries"

            if opencode run "$(cat .github/workflows/opencode-prompt.md)" \
              --model opencode/glm-4.7-free \
              --share false; then
              echo "OpenCode execution succeeded"
              break
            else
              retry_count=$((retry_count + 1))
              echo "OpenCode execution failed, retrying in 30 seconds..."
              sleep 30
              if [ $retry_count -eq $max_retries ]; then
                echo "All retry attempts failed"
                exit 1
              fi
            fi
          done

      - name: Fallback on Failure
        uses: ./.github/actions/failure-notification
        if: failure()
        with:
          workflow_name: 'OC-01'
          run_id: ${{ github.run_id }}
