import{j as i,C}from"../assets/index-lcGYEVDC.js";import{r as h}from"./chunk-BBfZGTUb.js";import{G as E}from"./chunk-B_AUdD3w.js";import{v as I}from"./chunk-BKT09osN.js";function D(){return{VITE_API_KEY:"AIzaSyC9bAVrui80T6kGmCFeovA_TY4h4EQRRJQ",VITE_WORKER_URL:"https://malnu-api.sulhi-cmz.workers.dev",NODE_ENV:"development"}}const k=D(),K=k.VITE_API_KEY,j=k.VITE_WORKER_URL;var f=(c=>(c.User="user",c.AI="ai",c))(f||{});class V{config;storageAdapter;constructor(e){this.config=e,this.storageAdapter=e.storageAdapter}async addMemory(e,t,a){const r=new Date,n={id:I(),content:e,type:t,timestamp:r,metadata:a,importance:this.config.defaultImportance||.5,accessCount:0};return await this.storageAdapter.store(n),n}async getMemory(e){const t=await this.storageAdapter.retrieve(e);return t?(await this.updateMemory(e,{accessCount:t.accessCount+1,lastAccessed:new Date}),await this.storageAdapter.retrieve(e)):null}async searchMemories(e){return this.storageAdapter.search(e)}async updateMemory(e,t){if(t.accessCount===void 0){const a=await this.storageAdapter.retrieve(e);a&&(t.accessCount=a.accessCount)}await this.storageAdapter.update(e,t)}async deleteMemory(e){await this.storageAdapter.delete(e)}async getRelevantMemories(e,t=10){return(await this.storageAdapter.getAll()).map(n=>{const o=n.content.toLowerCase(),d=e.toLowerCase().split(/\s+/);n.metadata;let s=0;d.forEach(y=>{if(y.length>2){const m=(o.match(new RegExp(y,"g"))||[]).length;s+=m*n.importance}}),(n.type==="context"||n.type==="fact")&&(s*=1.5);const l=(Date.now()-n.timestamp.getTime())/(1e3*60*60*24),p=Math.max(0,1-l/30);s*=1+p;const x=Math.min(n.accessCount*.1,.5);return s*=1+x,{memory:n,score:s}}).filter(({score:n})=>n>0).sort((n,o)=>o.score-n.score).slice(0,t).map(({memory:n})=>n)}async cleanup(){const e=await this.storageAdapter.getAll(),t=this.config.maxMemories||1e3;if(e.length<=t)return 0;const a=e.sort((n,o)=>{const d=n.importance+n.accessCount*.1+1/(1+(Date.now()-n.timestamp.getTime())/864e5),s=o.importance+o.accessCount*.1+1/(1+(Date.now()-o.timestamp.getTime())/(1e3*60*60*24));return d-s});a.slice(0,t);const r=a.slice(t);for(const n of r)await this.storageAdapter.delete(n.id);return r.length}async getStats(){const e=await this.storageAdapter.getAll(),t=e.reduce((n,o)=>(n[o.type]=(n[o.type]||0)+1,n),{}),a=e.length>0?e.reduce((n,o)=>n+o.importance,0)/e.length:0;let r=0;if("getStats"in this.storageAdapter)try{r=(await this.storageAdapter.getStats()).size||0}catch(n){console.warn("Failed to get storage stats:",n)}return{totalMemories:e.length,memoriesByType:t,averageImportance:a,storageSize:r}}updateConfig(e){this.config=e}async exportMemories(){const e=await this.storageAdapter.getAll();return JSON.stringify(e,null,2)}async importMemories(e){try{const t=JSON.parse(e);let a=0;for(const r of t)try{if(!r.id||!r.content||!r.type){console.warn("Skipping invalid memory:",r);continue}typeof r.timestamp=="string"&&(r.timestamp=new Date(r.timestamp)),r.lastAccessed&&typeof r.lastAccessed=="string"&&(r.lastAccessed=new Date(r.lastAccessed)),await this.storageAdapter.store(r),a++}catch(n){console.error("Failed to import memory:",r,n)}return a}catch(t){throw console.error("Failed to parse import data:",t),new Error("Invalid JSON data for import")}}async getMemoriesByType(e){return this.storageAdapter.search({type:e,limit:100})}async getRecentMemories(e=20){const t={limit:e};return this.storageAdapter.search(t)}}class R{config;memoryService;eventListeners=new Map;constructor(e){this.config={maxMemories:1e3,defaultImportance:.5,enableAutoCleanup:!0,cleanupThreshold:.8,...e},this.memoryService=new V(e),this.setupAutoCleanup()}async addMemory(e,t,a){const r=await this.memoryService.addMemory(e,t,a);return this.emit("memoryAdded",r),r}async getMemory(e){return this.memoryService.getMemory(e)}async searchMemories(e){const t=await this.memoryService.searchMemories(e);return this.emit("memorySearched",e,t),t}async updateMemory(e,t){const a=await this.memoryService.updateMemory(e,t);this.emit("memoryUpdated",a)}async deleteMemory(e){await this.memoryService.deleteMemory(e),this.emit("memoryDeleted",e)}async getRelevantMemories(e,t=10){return this.memoryService.getRelevantMemories(e,t)}async cleanup(){const e=await this.memoryService.cleanup();this.emit("cleanupPerformed",e)}async getStats(){return this.memoryService.getStats()}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const a=this.eventListeners.get(e);if(a){const r=a.indexOf(t);r>-1&&a.splice(r,1)}}emit(e,...t){const a=this.eventListeners.get(e);a&&a.forEach(r=>{try{r(...t)}catch(n){console.error(`Error in event listener for ${e}:`,n)}})}setupAutoCleanup(){this.config.enableAutoCleanup&&setInterval(async()=>{try{(await this.getStats()).totalMemories>(this.config.maxMemories||1e3)*(this.config.cleanupThreshold||.8)&&await this.cleanup()}catch(e){console.error("Auto-cleanup failed:",e)}},60*60*1e3)}getStorageAdapter(){return this.config.storageAdapter}updateConfig(e){this.config={...this.config,...e},this.memoryService.updateConfig(this.config)}}class W{storageKey="memory_bank_memories";metadataKey="memory_bank_metadata";constructor(e){e&&(this.storageKey=e)}async store(e){try{const t=await this.getAllMemories(),a=t.findIndex(r=>r.id===e.id);a>=0?t[a]=e:t.push(e),localStorage.setItem(this.storageKey,JSON.stringify(t)),this.updateMetadata()}catch(t){throw console.error("Failed to store memory:",t),new Error("Failed to store memory in localStorage")}}async retrieve(e){try{return(await this.getAllMemories()).find(a=>a.id===e)||null}catch(t){return console.error("Failed to retrieve memory:",t),null}}async search(e){try{let t=await this.getAllMemories();if(e.type&&(t=t.filter(a=>a.type===e.type)),e.minImportance!==void 0&&(t=t.filter(a=>a.importance>=e.minImportance)),e.keywords&&e.keywords.length>0&&(t=t.filter(a=>e.keywords.some(r=>a.content.toLowerCase().includes(r.toLowerCase())))),e.dateRange){const a=e.dateRange.start.getTime(),r=e.dateRange.end.getTime();t=t.filter(n=>{const o=n.timestamp.getTime();return o>=a&&o<=r})}return e.metadata&&(t=t.filter(a=>a.metadata&&this.matchesMetadata(a.metadata,e.metadata))),t.sort((a,r)=>{const n=a.importance+a.accessCount*.1;return r.importance+r.accessCount*.1-n}),e.limit&&(t=t.slice(0,e.limit)),t}catch(t){return console.error("Failed to search memories:",t),[]}}async update(e,t){try{const a=await this.retrieve(e);if(!a)throw new Error(`Memory with id ${e} not found`);const r={...a,...t,id:e,timestamp:a.timestamp};await this.store(r)}catch(a){throw console.error("Failed to update memory:",a),a}}async delete(e){try{const t=await this.getAllMemories(),a=t.filter(r=>r.id!==e);if(a.length===t.length)throw new Error(`Memory with id ${e} not found`);localStorage.setItem(this.storageKey,JSON.stringify(a)),this.updateMetadata()}catch(t){throw console.error("Failed to delete memory:",t),t}}async getAll(){return this.getAllMemories()}async clear(){try{localStorage.removeItem(this.storageKey),localStorage.removeItem(this.metadataKey)}catch(e){throw console.error("Failed to clear memories:",e),e}}async getAllMemories(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e).map(a=>({...a,timestamp:new Date(a.timestamp),lastAccessed:a.lastAccessed?new Date(a.lastAccessed):void 0})):[]}catch(e){return console.error("Failed to parse memories from localStorage:",e),[]}}updateMetadata(){try{const e={lastUpdated:new Date,storageSize:this.getStorageSize()};localStorage.setItem(this.metadataKey,JSON.stringify(e))}catch(e){console.error("Failed to update metadata:",e)}}getStorageSize(){try{const e=localStorage.getItem(this.storageKey);return e?new Blob([e]).size:0}catch(e){return console.error("Failed to calculate storage size:",e),0}}matchesMetadata(e,t){return Object.entries(t).every(([a,r])=>e[a]===r)}async getStats(){return{count:(await this.getAllMemories()).length,size:this.getStorageSize()}}}const T={maxMemories:2e3,defaultImportance:.6,storageAdapter:new W("school_memory_bank"),enableAutoCleanup:!0,cleanupThreshold:.85},_=new E({apiKey:K}),L=`${j}/api/chat`,A=new R(T);async function*F(c,e){let t="";try{const s=await fetch(L,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:c})});s.ok&&(t=(await s.json()).context)}catch{}let a="";try{const s=await A.getRelevantMemories(c,3);s.length>0&&(a=s.map(l=>l.content).join(`
---
`))}catch(s){console.warn("Failed to get memory context:",s)}let r=c;t&&a?r=`Berdasarkan konteks dari website sekolah:
---
${t}
---

Dan konteks percakapan sebelumnya:
---
${a}
---

Jawab pertanyaan ini: ${c}`:t?r=`Berdasarkan konteks berikut:
---
${t}
---

Jawab pertanyaan ini: ${c}`:a&&(r=`Berdasarkan konteks percakapan sebelumnya:
---
${a}
---

Jawab pertanyaan ini: ${c}`);const n="Anda adalah 'Asisten MA Malnu Kananga', chatbot AI yang ramah, sopan, dan sangat membantu, berbicara dalam Bahasa Indonesia. Tugas Anda adalah menjawab pertanyaan tentang sekolah MA Malnu Kananga berdasarkan konteks yang diberikan dari website sekolah. Jika konteks tidak cukup untuk menjawab, katakan Anda tidak memiliki informasi tersebut dan sarankan untuk menghubungi pihak sekolah. JANGAN menjawab pertanyaan di luar topik sekolah.",o=[...e.map(s=>({role:s.role,parts:[{text:s.parts}]})),{role:"user",parts:[{text:r}]}];let d="";try{const s=await _.models.generateContentStream({model:"gemini-2.5-flash",contents:o,config:{systemInstruction:n}});for await(const l of s)d+=l.text,yield l.text;try{await A.addMemory(`Pertanyaan: ${c}
Jawaban: ${d}`,"conversation",{type:"user_ai_interaction",userMessage:c,aiResponse:d,timestamp:new Date().toISOString(),contextUsed:!!t,memoryContextUsed:!!a})}catch(l){console.warn("Failed to store conversation in memory bank:",l)}}catch(s){yield"Maaf, terjadi masalah saat menghubungi AI. Silakan coba lagi nanti.";try{await A.addMemory(`Pertanyaan: ${c}
Error: ${s instanceof Error?s.message:"Unknown error"}`,"conversation",{type:"failed_interaction",userMessage:c,error:s instanceof Error?s.message:"Unknown error",timestamp:new Date().toISOString()})}catch(l){console.warn("Failed to store error in memory bank:",l)}}}const $="Assalamualaikum! Saya Asisten AI MA Malnu Kananga. Ada yang bisa saya bantu terkait informasi sekolah, pendaftaran, atau kegiatan?",O=()=>i.jsxDEV("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 transform rotate-45 -translate-y-px",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:i.jsxDEV("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/icons/SendIcon.tsx",lineNumber:13,columnNumber:9},void 0)},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/icons/SendIcon.tsx",lineNumber:5,columnNumber:5},void 0),P=({isOpen:c,closeChat:e})=>{const[t,a]=h.useState([]),[r,n]=h.useState([]),[o,d]=h.useState(""),[s,l]=h.useState(!1),p=h.useRef(null),x=()=>{p.current?.scrollIntoView({behavior:"smooth"})};h.useEffect(()=>{c&&t.length===0&&a([{id:"initial",text:$,sender:f.AI}])},[c,t.length]),h.useEffect(()=>{x()},[t]);const y=h.useCallback(async m=>{if(m?.preventDefault(),!o.trim()||s)return;const M=o,S={id:Date.now().toString(),text:M,sender:f.User};a(u=>[...u,S]),d(""),l(!0);const N=(Date.now()+1).toString();a(u=>[...u,{id:N,text:"",sender:f.AI}]);let w="";try{const u=F(M,r);for await(const b of u)w+=b,a(v=>v.map(g=>g.id===N?{...g,text:w}:g))}catch{const b="Maaf, terjadi kesalahan. Silakan coba lagi.";a(v=>v.map(g=>g.id===N?{...g,text:b}:g)),w=b}finally{l(!1),n(u=>[...u,{role:"user",parts:M},{role:"model",parts:w}])}},[o,s,r]);return i.jsxDEV("div",{className:"flex flex-col h-full bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden",children:[i.jsxDEV("header",{className:"flex items-center justify-between p-4 bg-green-600 text-white",children:[i.jsxDEV("div",{className:"flex items-center",children:[i.jsxDEV("div",{className:"w-3 h-3 bg-white rounded-full mr-2 animate-pulse"},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:89,columnNumber:13},void 0),i.jsxDEV("h2",{className:"font-bold text-lg",children:"Asisten AI"},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:90,columnNumber:13},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:88,columnNumber:9},void 0),i.jsxDEV("button",{onClick:e,className:"p-1 rounded-full hover:bg-white/20","aria-label":"Tutup obrolan",children:i.jsxDEV(C,{},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:93,columnNumber:13},void 0)},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:92,columnNumber:9},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:87,columnNumber:7},void 0),i.jsxDEV("div",{className:"flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-gray-900",children:i.jsxDEV("div",{className:"flex flex-col space-y-4",children:[t.map(m=>i.jsxDEV("div",{className:`flex items-end max-w-xs md:max-w-md gap-2 ${m.sender===f.User?"self-end flex-row-reverse":"self-start"}`,children:i.jsxDEV("div",{className:`rounded-2xl p-3 text-sm md:text-base ${m.sender===f.User?"bg-green-500 text-white rounded-br-lg":"bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-lg"}`,children:[m.text,s&&m.sender===f.AI&&!m.text&&i.jsxDEV("div",{className:"flex items-center justify-center space-x-1",children:[i.jsxDEV("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0s"}},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:117,columnNumber:25},void 0),i.jsxDEV("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:118,columnNumber:25},void 0),i.jsxDEV("span",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:119,columnNumber:25},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:116,columnNumber:21},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:107,columnNumber:15},void 0)},m.id,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:101,columnNumber:13},void 0)),i.jsxDEV("div",{ref:p},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:125,columnNumber:11},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:99,columnNumber:9},void 0)},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:98,columnNumber:7},void 0),i.jsxDEV("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800",children:i.jsxDEV("form",{onSubmit:y,className:"flex items-center space-x-2",children:[i.jsxDEV("input",{type:"text",value:o,onChange:m=>d(m.target.value),placeholder:"Ketik pertanyaan Anda...",className:"flex-1 p-3 bg-gray-100 dark:bg-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 text-gray-800 dark:text-gray-200",disabled:s},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:132,columnNumber:11},void 0),i.jsxDEV("button",{type:"submit",disabled:s||!o.trim(),className:"p-3 bg-green-600 text-white rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500","aria-label":"Kirim pesan",children:i.jsxDEV(O,{},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:146,columnNumber:13},void 0)},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:140,columnNumber:11},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:131,columnNumber:9},void 0)},void 0,!1,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:130,columnNumber:7},void 0)]},void 0,!0,{fileName:"/home/user/Malnu-Kananga/src/components/ChatWindow.tsx",lineNumber:85,columnNumber:5},void 0)};export{P as default};
//# sourceMappingURL=ChatWindow-BTxqaZXb.js.map
