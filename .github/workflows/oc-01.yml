---
name: OC-01
on:
  workflow_dispatch:
  pull_request:
  issues:
  push:

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: global1
  cancel-in-progress: false

jobs:
  analyze:
    name: OC-01
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_KEY }}

    steps:
      - name: Wait in Queue
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 30
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.opencode
          key: opencode-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            opencode-${{ runner.os }}-

      - name: Configure Git
        run: |
          git config --global user.name "analyzer"
          git config --global user.email "analyzer@sanaabililhuda.com"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Merge
        run: |
          max_retries=3
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries"

            if opencode run "You are the Lead Autonomous Engineer & System Guardian. Analyze the repository, fix issues, and improve the codebase. Always commit changes and create PRs when done. Follow best practices for security, performance, and maintainability." \
              --model opencode/glm-4.7-free \
              --share false; then
              echo "OpenCode execution succeeded"
              break
            else
              retry_count=$((retry_count + 1))
              echo "OpenCode execution failed, retrying in 30 seconds..."
              sleep 30
              if [ $retry_count -eq $max_retries ]; then
                echo "All retry attempts failed"
                exit 1
              fi
            fi
          done

      - name: Fallback on Failure
        uses: ./.github/actions/failure-notification
        if: failure()
        with:
          workflow_name: 'OC-01'
          run_id: ${{ github.run_id }}