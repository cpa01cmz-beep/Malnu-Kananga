name: "Check PR"

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Jalankan tanpa merge (hanya laporkan)"
        type: boolean
        default: false
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: check-pr
  cancel-in-progress: true

jobs:
  check-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}   # <-- pakai secret GH_TOKEN
      OUTPUT_FILE: .github/auto-merge-report.md
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}  # <-- pakai PAT untuk commit/push

      - name: Kumpulkan PR & issue
        id: collect
        run: |
          set -euo pipefail
          gh pr list \
            --state open \
            --json number,title,isDraft,mergeable,reviewDecision,updatedAt,author,labels \
            --limit 50 > pr.json

          gh issue list \
            --state open \
            --json number,title,updatedAt,author,labels \
            --limit 50 > issues.json

          echo "PR_COUNT=$(jq 'length' pr.json)" >> "$GITHUB_ENV"
          echo "pr_json=$(jq -c '.' pr.json)" >> "$GITHUB_OUTPUT"
          echo "issue_json=$(jq -c '.' issues.json)" >> "$GITHUB_OUTPUT"

      - name: Pilih kandidat PR
        id: pick
        run: |
          set -euo pipefail
          jq -r '
            def pick:
              map(select(.isDraft==false and .mergeable!="CONFLICTING")) as $all
              | ([$all[] | select(.reviewDecision=="APPROVED")] ) as $approved
              | (if ($approved|length)>0 then $approved else $all end)
              | sort_by(.updatedAt) | reverse | .[0];
            pick
          ' pr.json > candidate.json || true

          if [ -s candidate.json ] && [ "$(jq -r '.number' candidate.json)" != "null" ]; then
            echo "PR_NUMBER=$(jq -r '.number' candidate.json)" >> "$GITHUB_ENV"
            echo "PR_TITLE=$(jq -r '.title' candidate.json)" >> "$GITHUB_ENV"
          fi

      - name: Analisis dengan Gemini (opsional)
        id: run_research
        continue-on-error: true
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-pro
          prompt: |
            Anda adalah asisten CI. Ringkas dalam 5–10 baris:
            1) PR mana yang paling layak di-merge dan alasannya.
            2) Risiko atau perhatian utama.
            3) Jika tidak ada PR siap, sarankan issue untuk dikerjakan.
            Data PR (JSON): ${{ steps.collect.outputs.pr_json }}
            Data issue (JSON): ${{ steps.collect.outputs.issue_json }}

      - name: Merge PR terpilih
        if: env.PR_NUMBER && (github.event_name != 'workflow_dispatch' || inputs.dry_run == 'false')
        run: |
          set -euo pipefail
          gh pr merge "$PR_NUMBER" --merge --delete-branch --body "Auto-merge via workflow #${{ github.run_id }}."
          echo "MERGED=true" >> "$GITHUB_ENV"

      - name: Tindak jika tidak ada PR siap
        if: "!env.PR_NUMBER"
        run: |
          set -euo pipefail
          if [ -s issues.json ] && [ "$(jq 'length' issues.json)" -gt 0 ]; then
            ISSUE_NUMBER=$(jq -r 'sort_by(.updatedAt)|reverse|.[0].number' issues.json)
            gh issue comment "$ISSUE_NUMBER" --body "Automasi: tidak ada PR yang siap di-merge. Meninjau issue ini berikutnya."
            echo "ISSUE_WORKED=$ISSUE_NUMBER" >> "$GITHUB_ENV"
          fi

      - name: Tulis laporan
        run: |
          {
            echo "# Laporan auto-merge $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
            echo "- Jumlah PR terbuka: ${PR_COUNT:-0}"
            if [ -n "${PR_NUMBER:-}" ]; then
              echo "- PR terpilih: #$PR_NUMBER — ${PR_TITLE:-}"
              echo "- Status merge: ${MERGED:-false}"
            else
              echo "- Tidak ada PR yang siap di-merge."
              echo "- Issue ditindaklanjuti: ${ISSUE_WORKED:-none}"
            fi
            echo
            echo "## Ringkasan Gemini"
            echo "${{ steps.run_research.outputs.text }}${{ steps.run_research.outputs.response }}${{ steps.run_research.outputs.summary }}"
          } > "$OUTPUT_FILE"

      - name: Commit dan push jika berubah
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT_FILE"
          if ! git diff --cached --quiet; then
            git commit -m "chore: laporan auto-merge"
            git push
          fi
