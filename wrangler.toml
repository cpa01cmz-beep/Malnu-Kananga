name = "malnu-kananga-worker"
main = "worker.js"
compatibility_date = "2024-01-01"

# Production deployment - worker deployed to:
# https://malnu-kananga-worker.cpa01cmz.workers.dev
#
# SETUP INSTRUCTIONS:
# 1. Create D1 database: wrangler d1 create malnu-kananga-db
# 2. Copy the database_id from output and replace placeholder below
# 3. Create R2 bucket: wrangler r2 bucket create malnu-kananga-files
# 4. Set strong JWT_SECRET environment variable (32+ characters recommended)
# 5. Set actual VITE_GEMINI_API_KEY from Google Cloud Console
# 6. Run: npm run validate-config to check configuration before deploying

# Environment bindings for production
[env.production]
name = "malnu-kananga-worker-prod"

# D1 Database bindings - create with: wrangler d1 create malnu-kananga-db
# Replace the placeholder database_id below with your actual D1 database ID
[[env.production.d1_databases]]
binding = "DB"
database_name = "malnu-kananga-db-prod"
# Use D1 database ID from environment variable
database_id = "${D1_DATABASE_ID}"

# Vectorize index bindings - create with: wrangler vectorize create malnu-kananga-index --dimensions=768 --metric=cosine
[[env.production.vectorize]]
binding = "VECTORIZE_INDEX"
index_name = "malnu-kananga-index"

# R2 Bucket bindings - create with: wrangler r2 bucket create malnu-kananga-files
[[env.production.r2_buckets]]
binding = "BUCKET"
bucket_name = "malnu-kananga-files"

# Environment variables
[env.production.vars]
# Set to your production domain (for CORS)
ALLOWED_ORIGIN = "https://ma-malnukananga.sch.id"
# Use JWT secret from environment variable
JWT_SECRET = "${JWT_SECRET}"
# Use Gemini API key from environment variable
# NOTE: Cloudflare Workers use GEMINI_API_KEY (WITHOUT VITE_ prefix)
# Frontend uses VITE_GEMINI_API_KEY (WITH VITE_ prefix) - these are DIFFERENT services
GEMINI_API_KEY = "${GEMINI_API_KEY}"
NODE_ENV = "production"
LOG_LEVEL = "error"

# Local development
[env.dev]
name = "malnu-kananga-worker-dev"

# D1 Database for development
# Create with: wrangler d1 create malnu-kananga-db-dev
[[env.dev.d1_databases]]
binding = "DB"
database_name = "malnu-kananga-db-dev"
# Use dev D1 database ID from environment variable
database_id = "${D1_DATABASE_ID_DEV}"

[[env.dev.vectorize]]
binding = "VECTORIZE_INDEX"
index_name = "malnu-kananga-index-dev"

[[env.dev.r2_buckets]]
binding = "BUCKET"
bucket_name = "malnu-kananga-files-dev"

[env.dev.vars]
# Allow all origins for local development
ALLOWED_ORIGIN = "*"
# Use development JWT secret from environment variable
JWT_SECRET = "${JWT_SECRET_DEV}"
# Set your Gemini API key for AI features
# NOTE: Worker uses GEMINI_API_KEY (WITHOUT VITE_ prefix)
# Frontend uses VITE_GEMINI_API_KEY (WITH VITE_ prefix) - these are DIFFERENT services
# Can be set in .env file instead: GEMINI_API_KEY=your_key
# GEMINI_API_KEY = "your_dev_gemini_api_key_here"
