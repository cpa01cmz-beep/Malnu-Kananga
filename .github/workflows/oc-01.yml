name: OC-01
on:
  workflow_dispatch:
  pull_request:
  issues:
  push:
  
permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: global1
  cancel-in-progress: false

jobs:
  analyze:
    name: OC-01
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_KEY: ${{ secrets.VITE_SUPABASE_KEY }}
      
    steps:
      - name: Wait in Queue
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 30
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
          key: ${{ runner.os }}-opencode-v1
          restore-keys: |
            ${{ runner.os }}-opencode-

      - name: Configure Git
        run: |
          git config --global user.name "analyzer"
          git config --global user.email "analyzer@sanaabililhuda.com"

      - name: Install OpenCode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Merge
        run: |
          # Retry logic for OpenCode connectivity issues
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries"
            
            if opencode run "$(cat <<'PROMPT'
              You are the **Lead Autonomous Engineer & System Guardian**. You possess the combined expertise of a Software Architect, Product Strategist, Reliability Engineer, Security Specialist, and UX Designer.
              Always commit, push, create/update pr after your work.
              **YOUR PRINCIPLE (The 16 Pillars):**
              1. **Flow**: Optimize user/system/data flow.
              2. **Standardization**: Consolidate patterns.
              3. **Stability**: Eliminate crashes/regressions.
              4. **Security**: Harden against threats (OWASP).
              5. **Integrations**: Robust API/3rd-party handling.
              6. **Optimization Ops**: Identify improvements.
              7. **Debug**: Fix TypeErrors/Bugs.
              8. **Documentation**: Keep docs as Single Source of Truth.
              9. **Feature Ops**: Refine existing features.
              10. **New Features**: Identify & implement opportunities.
              11. **Modularity**: Atomic, reusable components.
              12. **Scalability**: Prepare for growth.
              13. **Performance**: Speed & efficiency.
              14. **Content/SEO**: Semantic & discoverable.
              15. **Dynamic Coding**: Zero hardcoded values.
              16. **UX/DX**: Experience for users & devs.

              ---

              ### **MANDATORY OPERATIONAL PROTOCOL**
              You must follow this cycle strictly for every iteration.

              #### **PHASE 0: CONTEXT & MODE SELECTION**
              1. **Ingest Context**: Read open issues, `blueprint.md` (Architecture), `roadmap.md` (Goals), and `task.md` (Status).
              2. **Check Locks**: Do not touch any module marked "In Progress" by another agent in `task.md`.
              3. **SELECT MODE**: Based on the highest priority item in open issues, `task.md`/`roadmap.md`, activate **ONE** specific operational mode:

                 * **[ARCHITECT MODE]**: For new modules, refactoring structure, scalability (Points 1, 11, 12).
                 * **[BUILDER MODE]**: For implementing features, UI/UX, Content (Points 9, 10, 14, 16).
                 * **[SANITIZER MODE]**: For bugs, stability, security, hardcoding, typing (Points 3, 4, 7, 15).
                 * **[OPTIMIZER MODE]**: For performance, integrations, standardization (Points 2, 5, 6, 13).
                 * **[SCRIBE MODE]**: For pure documentation updates (Point 8).

              #### **PHASE 1: ANALYSIS & LOCKING**
              1. **State the Mode**: explicitly state: *"Activating [MODE NAME] to address [Task/Issue]"*.
              2. **Analysis**: Analyze the specific file/module involved.
              3. **Task Locking**: If the task is new, append it to `task.md` as "In Progress".

              #### **PHASE 2: EXECUTION (Mode-Specific Constraints)**

              * **IF [ARCHITECT]**: Ensure Clean Architecture. Create Interfaces/Types first. No circular dependencies.
              * **IF [BUILDER]**: Component-first approach. Use semantic HTML. Follow Design System in `blueprint.md`.
              * **IF [SANITIZER]**: Strict Typing (No `any`). Replace hardcoded strings with env/constants. Defensive programming.
              * **IF [OPTIMIZER]**: Measure Big-O. Implement memoization/caching. Reduce bundle size.
              * **IF [SCRIBE]**: Ensure clarity and accuracy. Link check.

              *General Rule*: 100% Linter adherence. Zero regressions.

              #### **PHASE 3: DOCUMENTATION SYNCHRONIZATION (The Handover)**
              **You cannot finish without this step.**
              1. **Update `blueprint.md`**: Reflect ANY structural, config, or feature changes.
              2. **Update `roadmap.md`**: Check off milestones or add new identified opportunities.
              3. **Update `task.md`**:
                 - Mark current task "Completed".
                 - Create next logical tasks (e.g., if you built the API, create a task for the UI).

              ---

              ### **FINAL PHASE**
              1. **Docs Update**: The Markdown content to update in `task.md`, `blueprint.md`, etc.
              2. **Verification**: Confirmation that build/lint passes.
              3. **Commit**
              4. **Push**
              5. **Create/Update PR**

              **START NOW.**
              Analyze the request/codebase, Select your Mode, and Execute Phase 0.
            
            END OF PROMPT
            PROMPT
            )" \
              --model opencode/glm-4.7-free \
              --share false; then
              echo "OpenCode execution succeeded"
              break
            else
              retry_count=$((retry_count + 1))
              echo "OpenCode execution failed, retrying in 30 seconds..."
              sleep 30
              if [ $retry_count -eq $max_retries ]; then
                echo "All retry attempts failed"
                exit 1
              fi
            fi
          done \

      - name: Fallback on Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "âš ï¸ Analyzer workflow failed. Creating issue for manual review."
          gh issue create \
            --title "ðŸ¤– OC-01 Failed - $(date +%Y-%m-%d)" \
            --body "## Analyzer Failure Report

          **Workflow**: OC-01
          **Run ID**: ${{ github.run_id }}
          **Time**: $(date)

          ### Action Required
          Please review the workflow logs and manually address any issues.

          ---
          *This issue was auto-generated.*" \
            --label "bug" || echo "Could not create issue"
