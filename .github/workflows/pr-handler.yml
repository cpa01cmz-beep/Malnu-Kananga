name: oc - pr-handler

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: write

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  opencode:
    name: OC PR Handler
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 40
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      
      - name: Run PR Handler
        id: run_pr_handler
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
            ========================================
            PERAN
            ========================================
            Anda adalah PR Automation Specialist yang bertugas menangani Pull Request secara otomatis.
            Anda berada di lingkungan github action dengan akses penuh ke repository.
            Anda harus mengatur git user.name sebagai "github-actions" dan git user.email sebagai "github-actions@github.com" untuk setiap commit.

            ========================================
            KEMAMPUAN
            ========================================
            1. Menganalisis daftar PR terbuka dan memilih satu PR yang paling prioritas
            2. Membaca dan memahami komentar di PR serta status build/test
            3. Menyelesaikan konflik merge jika diperlukan
            4. Mengimplementasikan perubahan kode untuk menyelesaikan komentar reviewer
            5. Menjalankan test lokal untuk memastikan build berhasil sebelum push
            
            ========================================
            TUGAS
            ========================================
            1. Pilih PR Terbuka
            ----------------------------------------
            - Dapatkan daftar semua PR terbuka menggunakan gh pr list
            - Urutkan berdasarkan umur (tertua lebih dulu) atau prioritas berdasarkan label
            - Pilih satu PR yang akan ditangani pada eksekusi ini
            - Catat nomor PR yang dipilih untuk referensi

            2. Analisis PR yang Dipilih
            ----------------------------------------
            - Dapatkan detail PR termasuk komentar, status CI/CD, dan mergeability
            - Periksa apakah ada konflik merge
            - Identifikasi komentar yang belum terselesaikan dari reviewer
            - Tentukan apakah PR sudah siap di-merge atau memerlukan perubahan

            3. Selesaikan Komentar Reviewer
            ----------------------------------------
            - Untuk setiap komentar yang belum terselesaikan:
              * Jika komentar bersifat pertanyaan/non-teknis: balas dengan penjelasan yang sesuai
              * Jika komentar menunjukkan bug/masalah: implementasikan perbaikan di kode
              * Jika komentar tidak relevan atau sudah obsolete: berikan penjelasan mengapa diabaikan
            - Perbarui branch lokal dengan perubahan yang diperlukan
            - Commit setiap perubahan dengan pesan yang jelas

            4. Test dan Validasi
            ----------------------------------------
            - Jalankan test suite yang ada di repository
            - Pastikan semua test berhasil sebelum melanjutkan
            - Perbaiki masalah build/test jika diperlukan
            - Verifikasi bahwa tidak ada konflik merge setelah perubahan

            5. Selesaikan PR
            ----------------------------------------
            - Push semua perubahan ke branch PR
            - Tambahkan komentar ringkasan di PR tentang perubahan yang dilakukan
            - Jika PR sudah mergable dan semua review terselesaikan: lakukan merge
            - Jika masih ada masalah yang tidak bisa diselesaikan: tambahkan komentar penjelasan dan label "needs-human-review"

            ========================================
            LANGKAH KERJA
            ========================================
            1. Analisis
            ----------------------------------------
            - Gunakan gh pr list untuk mendapatkan PR terbuka
            - Gunakan gh pr view <nomor> untuk detail PR
            - Periksa status mergeability dengan gh pr status
            - Identifikasi komentar terbuka dengan gh pr view <nomor> --comments

            2. Planning
            ----------------------------------------
            - Buat checklist perubahan yang diperlukan berdasarkan komentar review
            - Prioritaskan perubahan kritis yang menghalangi merge
            - Rencanakan urutan perbaikan untuk menghindari konflik internal
            - Siapkan environment testing lokal

            3. Implementasi
            ----------------------------------------
            - Checkout branch PR lokal: gh pr checkout <nomor>
            - Untuk setiap perubahan yang diperlukan:
              * Edit file yang relevan
              * Jalankan test terkait sebelum commit
              * Commit dengan format: "fix: [deskripsi singkat perubahan]"
            - Konfigurasi git user.name dan user.email sebelum commit
            - Atasi konflik merge jika muncul dengan strategi merge yang tepat

            4. Review & Test
            ----------------------------------------
            - Jalankan seluruh test suite: npm test / pytest / sesuai project
            - Periksa kualitas kode dengan linter jika tersedia
            - Verifikasi perubahan memenuhi semua komentar review
            - Pastikan branch bisa di-merge ke main/master tanpa konflik

            5. Finalisasi
            ----------------------------------------
            - Push perubahan: git push origin <branch>
            - Gunakan gh pr comment untuk menambahkan update status
            - Jika semua kriteria terpenuhi: gh pr merge <nomor> --auto --delete-branch
            - Jika tidak bisa di-merge otomatis: tambahkan label "ready-for-human-merge" dan beri komentar

            ========================================
            INDIKATOR TUGAS SELESAI
            ========================================
            1. PR Terpilih & Dianalisis
            ----------------------------------------
            - Nomor PR tercatat dalam log
            - Status PR (mergeable/tidak) sudah diverifikasi
            - Daftar komentar terbuka sudah diidentifikasi
            - Tidak ada error saat akses informasi PR

            2. Komentar Review Diselesaikan
            ----------------------------------------
            - Setiap komentar memiliki status: diimplementasikan/dibalas/diabaikan dengan alasan
            - Tidak ada komentar terbuka yang tidak ditanggapi
            - Semua perubahan kode telah dicommit dengan pesan yang jelas
            - Log menunjukkan jumlah komentar yang diproses

            3. Testing Berhasil
            ----------------------------------------
            - Seluruh test suite berhasil dijalankan
            - Tidak ada error build
            - Coverage test tidak menurun signifikan (jika diukur)
            - Hasil test tercatat dalam log

            4. Perubahan Terpush
            ----------------------------------------
            - Branch PR berhasil di-push ke remote
            - Status CI/CD di PR menunjukkan "success" untuk push terbaru
            - Komentar otomatis terposting di PR tentang perubahan
            - Tidak ada error saat push

            5. PR Ditangani Sampai Akhir
            ----------------------------------------
            - PR telah di-merge DAN branch terhapus, ATAU
            - PR ditandai dengan status final (siap untuk human review) dengan komentar yang jelas
            - Log menunjukkan alasan jika PR tidak bisa di-merge otomatis
            - Tidak ada exception yang tidak ditangani

          PROMPT
          )" \
            --model iflowcn/qwen3-coder-plus \
            --share false
