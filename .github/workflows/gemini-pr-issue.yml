name: üß† AI Repository Orchestrator

on:
  schedule:
    - cron: '0 * * * *' # Berjalan setiap jam
  workflow_dispatch: # Memungkinkan pemicuan manual

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: 1. üìö Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Mengambil semua riwayat untuk analisis commit

      - name: 2. üß† Setup Gemini CLI
        uses: google-github-actions/run-gemini-cli@v0.1.14

      - name: 3. üíæ Read Agent Memory
        id: memory
        run: |
          if [ -f .github/iflow/memory.md ]; then
            echo "memory_content=$(cat .github/iflow/memory.md | base64 -w 0)" >> $GITHUB_OUTPUT
          else
            echo "memory_content=" >> $GITHUB_OUTPUT
          fi

      - name: 4. üìä Gather Comprehensive Repository Context
        id: repo_context
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Fungsi untuk mengubah daftar menjadi format markdown
          to_markdown_list() {
            while IFS= read -r line; do
              echo "- $line"
            done
          }

          # Informasi Repositori Dasar
          REPO_NAME="${{ github.repository }}"
          REPO_SETTINGS=$(gh api repos/${REPO_NAME} --jq '{name, description, visibility, default_branch, language: .language, topics: .topics | join(", "), has_issues, has_projects, has_wiki, has_discussions}')

          # Analisis Log Alur Kerja
          WORKFLOW_LOGS=$(gh run list --limit 10 --json name,status,conclusion,createdAt,updatedAt --jq '.[] | "\(.name) (\(.status)/\(.conclusion)) - \(.updatedAt)"' | to_markdown_list)

          # Sejarah Commit
          COMMIT_HISTORY=$(git log --oneline --graph --decorate --all -n 15 | to_markdown_list)

          # Pull Requests Terbuka
          OPEN_PRS=$(gh pr list --state open --limit 15 --json title,number,author,createdAt,updatedAt,mergeable --jq '.[] | "#\(.number) \(.title) by @\(.author.login) (Mergeable: \(.mergeable))"' | to_markdown_list)

          # Pull Requests yang Ditutup/Digabungkan
          CLOSED_PRS=$(gh pr list --state merged --limit 15 --json title,number,author,mergedAt,mergedBy --jq '.[] | "#\(.number) \(.title) by @\(.author.login) merged by @\(.mergedBy.login)"' | to_markdown_list)

          # Isu Terbuka
          OPEN_ISSUES=$(gh issue list --state open --limit 15 --json title,number,author,createdAt,updatedAt --jq '.[] | "#\(.number) \(.title) by @\(.author.login)"' | to_markdown_list)

          # Isu yang Ditutup
          CLOSED_ISSUES=$(gh issue list --state closed --limit 15 --json title,number,author,closedAt --jq '.[] | "#\(.number) \(.title) by @\(.author.login)"' | to_markdown_list)

          # Menggabungkan semua konteks menjadi satu variabel
          FULL_CONTEXT=$(cat <<EOF
          **Repository:** ${REPO_NAME}
          **Timestamp UTC:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          **Pengaturan Repositori:**
          \`\`\`json
          ${REPO_SETTINGS}
          \`\`\`

          **Log Alur Kerja Terbaru (Actions):**
          ${WORKFLOW_LOGS:-"- Tidak ada log alur kerja yang ditemukan."}

          **Sejarah Commit Terbaru:**
          \`\`\`
          ${COMMIT_HISTORY:-"- Tidak ada riwayat commit yang ditemukan."}
          \`\`\`

          **Pull Requests Terbuka:**
          ${OPEN_PRS:-"- Tidak ada PR terbuka."}

          **Pull Requests Terbaru yang Digabungkan:**
          ${CLOSED_PRS:-"- Tidak ada PR yang baru digabungkan."}

          **Isu Terbuka:**
          ${OPEN_ISSUES:-"- Tidak ada isu terbuka."}

          **Isu Terbaru yang Ditutup:**
          ${CLOSED_ISSUES:-"- Tidak ada isu yang baru ditutup."}
          EOF
          )

          echo "full_context_b64=$(echo "$FULL_CONTEXT" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: 5. üöÄ Execute Gemini Orchestrator
        id: gemini_run
        uses: google-github-actions/run-gemini-cli@latest
        with:
          gemini-api-key: ${{ secrets.GEMINI_API_KEY }} # Pastikan Anda telah mengatur rahasia ini
          model: "gemini-2.5-flash-lite"
          prompt: |
            # PROMPT ORKESTRASI REPOSITORI GITHUB

            ## IDENTITAS & PERAN
            Anda adalah Orkestrator Repositori AI otonom yang berjalan di dalam GitHub Action. Tujuan utama Anda adalah menjaga kesehatan, efisiensi, dan kemajuan repositori ini. Anda cerdas, proaktif, dan mampu belajar dari waktu ke waktu. Memori Anda dari eksekusi sebelumnya disediakan di bawah ini.

            ## KONTEKS SAAT INI
            Berikut adalah snapshot komprehensif dari repositori pada saat eksekusi ini. Analisis semua bagian dengan cermat untuk membuat keputusan yang tepat.

            ### Konteks Repositori:
            $(echo "${{ steps.repo_context.outputs.full_context_b64 }}" | base64 -d)

            ### Memori Jangka Panjang (Learnings from Past Runs):
            """
            $(echo "${{ steps.memory.outputs.memory_content }}" | base64 -d)
            """

            ## MISI & TUJUAN
            Berdasarkan konteks dan memori yang diberikan, misi Anda adalah melakukan tindakan yang paling berdampak untuk memajukan repositori.

            ### TUGAS DEFAULT (Prioritas Tertinggi):
            1.  **Tinjau Pull Requests (PR) Terbuka:**
                -   Periksa setiap PR terbuka yang tercantum dalam konteks.
                -   Gunakan `gh pr diff <PR_NUMBER>` untuk melihat perubahan kode.
                -   Gunakan `gh pr view <PR_NUMBER> --comments` untuk membaca semua percakapan dan komentar yang ada.
                -   **Tujuan:** Atasi/selesaikan SEMUA komentar percakapan yang ada di setiap PR. Berikan umpan balik yang membangun, ajukan pertanyaan klarifikasi, atau setujui perubahan jika sesuai.
            2.  **Evaluasi Status Penggabungan (Merge):**
                -   Setelah semua percakapan di PR diselesaikan, periksa statusnya menggunakan `gh pr status <PR_NUMBER>`.
                -   **Kriteria Penggabungan:** Lanjutkan ke penggabungan HANYA JIKA SEMUA kondisi berikut terpenuhi:
                    a.  Semua percakapan telah diselesaikan.
                    b.  Pemeriksaan status CI/CD (GitHub Actions) semuanya "hijau" atau berhasil.
                    c.  Tidak ada konflik penggabungan.
            3.  **Lakukan Penggabungan:**
                -   Jika semua kriteria terpenuhi, gabungkan PR menggunakan `gh pr merge <PR_NUMBER> --squash --delete-branch`. Gunakan metode *squash* untuk menjaga kebersihan riwayat commit.

            ### TUGAS SEKUNDER (Jika tidak ada PR yang memerlukan tindakan):
            -   Analisis Isu Terbuka: Apakah ada isu yang dapat ditutup, atau yang memerlukan label?
            -   Identifikasi Pola: Apakah ada kegagalan alur kerja yang berulang? Atau jenis PR yang sering mengalami masalah? Catat ini dalam pembaruan memori Anda.
            -   Saran Proaktif: Berdasarkan analisis Anda, sarankan perbaikan pada alur kerja, dokumentasi, atau proses pengembangan.

            ## ATURAN INTERAKSI & OUTPUT
            -   **Gunakan GitHub CLI (`gh`):** Semua interaksi dengan repositori (mengomentari PR, menggabungkan, dll.) HARUS dilakukan menggunakan perintah `gh`. Token `GH_TOKEN` telah disediakan untuk otentikasi.
            -   **Format Output:** Respon Anda HARUS dalam format JSON yang berisi dua kunci:
                1.  `actions`: Sebuah array string, di mana setiap string adalah perintah `gh` yang valid yang perlu dieksekusi.
                2.  `memory_update`: Sebuah string markdown yang merangkum tindakan yang Anda ambil, pengamatan yang Anda buat, dan wawasan apa pun untuk meningkatkan eksekusi di masa mendatang. Ini akan disimpan dan diberikan kepada Anda pada proses berikutnya.

            ### CONTOH OUTPUT:
            ```json
            {
              "actions": [
                "gh pr review 123 --approve -b \"Perubahan terlihat bagus, semua tes lulus. Siap untuk digabungkan.\"",
                "gh pr merge 123 --squash --delete-branch"
              ],
              "memory_update": "Siklus ini berhasil meninjau dan menggabungkan PR #123. Mengamati bahwa pemeriksaan linting sering gagal pada PR awal; mungkin perlu menambahkan hook pre-commit untuk pengembang."
            }
            ```

      - name: 6. ‚ö°Ô∏è Execute Actions and Update Memory
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Ekstrak dan jalankan perintah
          ACTIONS=$(echo "${{ steps.gemini_run.outputs.response }}" | jq -r '.actions[]')
          if [ -n "$ACTIONS" ]; then
            echo "üöÄ Executing Actions..."
            while IFS= read -r action; do
              echo "Executing: $action"
              eval "$action"
            done <<< "$ACTIONS"
          else
            echo "No actions to execute."
          fi

          # Perbarui file memori
          MEMORY_UPDATE=$(echo "${{ steps.gemini_run.outputs.response }}" | jq -r '.memory_update')
          if [ -n "$MEMORY_UPDATE" ]; then
            echo "üíæ Updating memory..."
            mkdir -p .github/iflow
            echo -e "## Update from $(date -u)\n\n$MEMORY_UPDATE\n\n---\n\n$(cat .github/iflow/memory.md 2>/dev/null)" > .github/iflow/memory.md

            # Commit perubahan memori kembali ke repositori
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add .github/iflow/memory.md
            git commit -m "üß† chore: Update AI agent memory" || echo "No memory changes to commit."
            git push || echo "Failed to push memory update, might be up-to-date."
          else
            echo "No memory update provided."
          fi
