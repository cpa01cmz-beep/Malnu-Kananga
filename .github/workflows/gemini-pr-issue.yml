name: "Check PR"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  id-token: write

jobs:
  research:
    runs-on: ubuntu-latest
    env:
      OUTPUT_FILE: free-vps.md
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Run Gemini CLI
        id: run_research
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          prompt: |
            Anda memiliki akses ke gh cli. Periksa pr terbuka dan issue terbuka. prioritaskan pr, jika tidak ada yang terbuka, maka bekerja dengan issue.  
            Pilih satu pr paling penting, lihat semua komentar di percakapan, pertimbangkan untuk apply sesuai saran di komentar. merge pr.
          upload_artifacts: false

      - name: Write output to file
        run: |
          echo "${{ steps.run_research.outputs.summary }}" > ${{ env.OUTPUT_FILE }}

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.OUTPUT_FILE }}
          if ! git diff --cached --quiet; then
            git commit -m "Update freeâ€‘VPS list"
            git push
          fi
