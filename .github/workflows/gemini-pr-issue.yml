name: "Check PR"

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Jalankan tanpa merge (hanya laporkan)"
        type: boolean
        default: false
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: check-pr
  cancel-in-progress: true

jobs:
  check-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}   # <-- pakai secret GH_TOKEN
      OUTPUT_FILE: .github/auto-merge-report.md
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}  # <-- pakai PAT untuk commit/push

      - name: Kumpulkan PR & issue
        id: collect
        run: |
          set -euo pipefail
          gh pr list \
            --state open \
            --json number,title,isDraft,mergeable,reviewDecision,updatedAt,author,labels \
            --limit 50 > pr.json

          gh issue list \
            --state open \
            --json number,title,updatedAt,author,labels \
            --limit 50 > issues.json

          echo "PR_COUNT=$(jq 'length' pr.json)" >> "$GITHUB_ENV"
          echo "pr_json=$(jq -c '.' pr.json)" >> "$GITHUB_OUTPUT"
          echo "issue_json=$(jq -c '.' issues.json)" >> "$GITHUB_OUTPUT"

      - name: Pilih kandidat PR
        id: pick
        run: |
          set -euo pipefail
          jq -r '
            def pick:
              map(select(.isDraft==false and .mergeable!="CONFLICTING")) as $all
              | ([$all[] | select(.reviewDecision=="APPROVED")] ) as $approved
              | (if ($approved|length)>0 then $approved else $all end)
              | sort_by(.updatedAt) | reverse | .[0];
            pick
          ' pr.json > candidate.json || true

          if [ -s candidate.json ] && [ "$(jq -r '.number' candidate.json)" != "null" ]; then
            echo "PR_NUMBER=$(jq -r '.number' candidate.json)" >> "$GITHUB_ENV"
            echo "PR_TITLE=$(jq -r '.title' candidate.json)" >> "$GITHUB_ENV"
          fi

      - name: Analisis dengan Gemini
        id: run_research
        continue-on-error: true
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-pro
          prompt: |
            Anda adalah AI Agent yang mengelola github repository. 
            Anda berada di lingkungan github action, mampu menggunakan Github CLI dengan optimal.
            Anda juga sangat memahami iflow cli (https://github.com/iflow-ai/iflow-cli/tree/main/docs_en).
            Anda mampu berkembang seiring waktu. 
            Data PR (JSON): ${{ steps.collect.outputs.pr_json }}
            Data issue (JSON): ${{ steps.collect.outputs.issue_json }}
