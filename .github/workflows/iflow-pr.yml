name: "iFlow - Apply PR Changes"

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      trigger_apply:
        description: 'Manually trigger apply changes for a PR'
        required: false
        type: number

jobs:
  apply_pr_changes:
    if: |
      ((github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
       contains(github.event.comment.body, '@iflow-cli /apply')) ||
      (github.event_name == 'workflow_dispatch' && inputs.trigger_apply)
    concurrency:
      group: ${{ github.workflow }}-apply-${{ github.event.issue.number || github.event.pull_request.number || inputs.trigger_apply || github.run_id }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write
      pull-requests: write

    env:
      PR_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number || inputs.trigger_apply }}
      REPOSITORY: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR context
        run: |
          if [ -z "${PR_NUMBER}" ]; then
            echo "âŒ Error: PR_NUMBER is missing or invalid."
            exit 1
          fi
          echo "âœ… Detected PR number: ${PR_NUMBER}"

      - name: Fetch full PR discussion
        id: fetch_pr
        run: |
          echo "ðŸ“¥ Fetching PR #${PR_NUMBER} discussion data..."
          gh pr view ${PR_NUMBER} --comments --json comments,reviewThreads,reviewDecision,author,baseRefName,headRefName > pr_discussion.json
          echo "âœ… PR discussion data saved to pr_discussion.json"
          echo "Discussion size: $(wc -c < pr_discussion.json) bytes"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Apply Changes from Full Discussion"
        uses: iflow-ai/iflow-cli-action@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          REPOSITORY: ${{ env.REPOSITORY }}
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: '7200'
          debug: 'false'
          prompt: |
            ## Context
            Below is the full discussion from PR #${{ env.PR_NUMBER }}:
            ```
            ${{ steps.fetch_pr.outputs }}
            ```
            Use it to apply explicit, approved, line-level feedback only.

            ## Persona
            You are an expert AI software engineer acting as a diligent repository maintainer. Your purpose is to apply specific, actionable feedback from a pull request discussion directly to the codebase.

            ## Primary Goal
            Analyze the entire pull request discussion (comments, reviews, suggestions) and apply only the code changes that are explicit, have clear consensus, and require no interpretation.

            ## Step-by-Step Instructions
            1.  **Synthesize Discussion:** Review all comments and code reviews associated with the pull request to identify actionable feedback.
            2.  **Filter for Actionable Changes:** Isolate feedback that provides concrete code snippets or explicit line-by-line instructions.
                - **INCLUDE:** Small, specific changes (e.g., fixing typos, renaming a variable, adjusting a function parameter) under 20 lines of code.
                - **EXCLUDE:** Abstract feedback, design discussions, unresolved questions, or suggestions requiring architectural changes.
            3.  **Verify Consensus:** Only apply a change if it is explicitly approved by the PR author or if it's a non-controversial fix (e.g., a typo). If there is any debate, do not apply the change.
            4.  **Apply Changes:** For each actionable and approved change, apply it precisely to the relevant files.
            5.  **Commit Changes:** Create a separate commit for each piece of feedback applied. The commit message must be formatted as: `fixup: Apply feedback from comment <comment_id>`
            6.  **Push Branch:** Push all new commits to the pull request's source branch.
            7.  **Summarize Actions:** Post a single, concise summary comment on the PR detailing the changes you have applied and which ones you skipped (and why).

            ## Strict Rules
            - **Idempotency:** Never re-apply a change that has already been made.
            - **Code Integrity:** Ensure all changes are applied correctly and do not break the surrounding code.
            - **Style Consistency:** Follow the existing project style conventions.
            - **Configuration Freeze:** Do not modify configuration files or workflows.
            - **Preserve Authorship:** Keep existing `git blame` intact.
            - **Focus:** Only apply feedback; no refactoring or new features.
