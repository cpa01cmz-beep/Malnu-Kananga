name: "ðŸ¤– iFlow CLI Automation"

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  pull_request_review_comment:
    types: [created]
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Optional: issue number to triage or implement'
        required: false
        type: number
      pr_number:
        description: 'Optional: pull request number to review or apply changes'
        required: false
        type: number

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  triage_issue:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@iflow-cli /triage')) ||
      (github.event_name == 'workflow_dispatch' && inputs.issue_number)
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true
    uses: ./.github/workflows/_reusable/iflow-cli.yml
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    with:
      timeout: '7200'
      debug: 'false'
      api_key: ${{ secrets.IFLOW_API_KEY }}
      prompt: |
        ## Role
        You are an AI developer and project manager responsible for
        triaging issues and implementing features or bug fixes
        described in those issues. Operate entirely through the
        GitHub CLI (`gh`) and the local git repository.

        ## Context
        * The current issue title is "${{ env.ISSUE_TITLE }}".
        * The issue body contains:
          "${{ env.ISSUE_BODY }}".
        * The issue number is `${{ env.ISSUE_NUMBER }}` in
          repository `${{ env.REPOSITORY }}`.
        * You have access to `gh` commands authenticated with
          `${{ env.GH_TOKEN }}` and a checked-out repository.

        ## Tasks
        1. List existing labels using `gh label list` and classify the
           issue by kind (bug, enhancement, documentation, cleanup, etc.)
           and priority (p0â€“p3). Apply labels using
           `gh issue edit "$ISSUE_NUMBER" --add-label`.
        2. Determine whether the issue requires an implementation.
        3. If implementation is required:
           a. Create a new git branch `iflow/issue-${{ env.ISSUE_NUMBER }}`.
           b. Modify or create files to implement the feature/fix.
           c. Commit, push, and open a PR referencing the issue.

        ## Guidelines
        * Use only existing labels.
        * Keep implementations small and focused.
        * Never expose secrets.
        * Prefer clarity and maintainability.
    env:
      ISSUE_TITLE: ${{ github.event.issue.title || 'manual' }}
      ISSUE_BODY: ${{ github.event.issue.body || '' }}
      ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
      REPOSITORY: ${{ github.repository }}
    timeout-minutes: 120

  review_pr:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@iflow-cli /review')) ||
      (github.event_name == 'workflow_dispatch' && inputs.pr_number)
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    uses: ./.github/workflows/_reusable/iflow-cli.yml
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    with:
      timeout: '7200'
      debug: 'false'
      api_key: ${{ secrets.IFLOW_API_KEY }}
      prompt: |
        ## Role
        You are an AI code reviewer for this repository.

        ## Tasks
        1. `gh pr checkout $PR_NUMBER`.
        2. `git diff $BASE_REF...$HEAD_REF` to inspect changes.
        3. Review for quality, security, performance, and style.
        4. Post summary via `gh pr comment $PR_NUMBER --body "<review>"`.
        ## Constraints
        * Do not merge the PR.
    env:
      PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
      BASE_REF: ${{ github.event.pull_request.base.ref || 'main' }}
      HEAD_REF: ${{ github.event.pull_request.head.ref || '' }}
      REPOSITORY: ${{ github.repository }}
    timeout-minutes: 120

  apply_pr_changes:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && inputs.pr_number)
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    uses: ./.github/workflows/_reusable/iflow-cli.yml
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    with:
      timeout: '7200'
      debug: 'false'
      api_key: ${{ secrets.IFLOW_API_KEY }}
      prompt: |
        ## Role
        You are an autonomous AI maintainer for this repository.
        You analyze all comments (review + conversation) in the PR and
        decide whether to apply safe, local changes.

        ## Context
        * Pull request number: `${{ env.PR_NUMBER }}`
        * Repository: `${{ env.REPOSITORY }}`

        ## Inputs
        The combined data from:
        - `review_comments.json` (code review)
        - `issue_comments.json` (conversation)

        ## Tasks
        1. `gh pr checkout $PR_NUMBER`.
        2. Iterate all comments, apply only valid suggestions:
           - GitHub suggested change blocks
           - Small, local refactors, doc fixes, or safe tweaks.
        3. Run `git commit -am "Apply valid review suggestions"` and `git push`.
        4. Post a summary comment:
           `gh pr comment $PR_NUMBER --body "âœ… Applied safe review suggestions automatically."`.

        ## When to skip
        - Comment vague, abstract, or non-technical.
        - Requests large or risky changes.
        - Security, test, or CI modifications unless explicitly safe.

        ## Constraints
        - Do not merge PR.
        - Never expose secrets.
        - Keep edits minimal, local, and reversible.
    env:
      PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
      REPOSITORY: ${{ github.repository }}
    timeout-minutes: 120

  maintenance:
    if: github.event_name == 'schedule'  
    uses: ./.github/workflows/_reusable/iflow-cli.yml
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    with:
      timeout: '10800'
      debug: 'false'
      api_key: ${{ secrets.IFLOW_API_KEY }}
      prompt: |
        ## Role
        You are an AI architect and security engineer for this repository.

        ## Tasks
        1. Scan for performance issues, deprecated APIs, and vulnerabilities.
        2. Refactor, remove dead code, and update dependencies where safe.
        3. Create branch `iflow/maintenance/${{ github.run_id }}`.
        4. Commit and open a PR via `gh pr create --fill`.

        ## Guidelines
        * Follow existing style and structure.
        * Group related changes.
        * Document significant impacts.
    env:
      REPOSITORY: ${{ github.repository }}
    timeout-minutes: 180
