# Nama Alur Kerja: Orkestrator Repositori Cerdas Gemini
# Dibuat untuk bertindak sebagai agen AI yang mengelola dan memelihara repositori.
# Mampu belajar dan berkembang dari waktu ke waktu melalui file memori.
name: 'Gemini: Intelligent Repository Orchestrator'

on:
  # 1. Jadwal: Berjalan secara otomatis setiap jam.
  schedule:
    - cron: '0 * * * *'

  # 2. Dispatch Manual: Memungkinkan pemicuan manual dengan prompt kustom.
  workflow_dispatch:
    inputs:
      dispatch_prompt:
        description: 'Instruksi atau tugas khusus untuk agen Gemini (opsional).'
        required: false
        default: 'Jalankan siklus orkestrasi standar.'

# Izin yang diperlukan untuk GITHUB_TOKEN agar agen dapat berinteraksi dengan repositori.
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    
    steps:
      # Langkah 1: Checkout kode repositori
      - name: '1. Checkout Repository Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 20

      # Langkah 2: Kumpulkan Konteks Komprehensif (Versi Final & Stabil)
      - name: '2. Gather Comprehensive Repository Context (Final Stable Version)'
        id: context_gatherer
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "Memulai pengumpulan konteks untuk repositori: $GITHUB_REPOSITORY"

          REPO_CONTEXT="### Konteks Repositori Utama\n*   **Repositori:** $GITHUB_REPOSITORY\n*   **Pemicu Aksi:** ${{ github.event_name }}\n*   **Aktor Pemicu:** ${{ github.actor }}\n*   **Judul PR (jika ada):** ${{ github.event.pull_request.title }}\n*   **Nomor PR (jika ada):** ${{ github.event.pull_request.number }}\n"
          COMMIT_HISTORY=$(git log --pretty=format:'- %h: %s oleh %an' -n 20)
          ACTION_LOGS=$(gh run list --limit 10 --json name,status,conclusion --template '{{range .}}{{- printf "- %s: %s (%s)\n" .name .status .conclusion}}{{end}}')

          # Mengambil info PR tanpa status pemeriksaan untuk menghindari error.
          OPEN_PRS=$(gh pr list --state open --limit 10 --json number,title,author,headRefName,baseRefName,comments,reviews --template '{{range .}}{{- printf "### PR #%v: %s\n" .number .title}}{{- printf "*   **Cabang:** %s -> %s\n" .headRefName .baseRefName}}{{- printf "*   **Penulis:** %s\n" .author.login}}{{- if .reviews }}{{- printf "*   **Ulasan:**\n"}}{{range .reviews}}{{- printf "    - %s oleh %s\n" .state .author.login}}{{end}}{{end}}{{- if .comments }}{{- printf "*   **Komentar Terbaru:**\n"}}{{range .comments}}{{- printf "    - \"%s\" oleh %s\n" .body .author.login}}{{end}}{{end}}{{printf "\n"}}{{end}}')
          if [ -z "$OPEN_PRS" ]; then OPEN_PRS="Tidak ada Pull Request yang terbuka."; fi

          # =================== BAGIAN YANG DIPERBAIKI ===================
          # Menggunakan field 'comments' yang benar dan menghitung panjangnya dengan '(len .comments)'
          OPEN_ISSUES=$(gh issue list --state open --limit 5 --json number,title,author,comments --template '{{range .}}{{- printf "- **Isu #%v:** %s (oleh %s, %v komentar)\n" .number .title .author.login (len .comments)}}{{end}}')
          # =================== AKHIR DARI PERBAIKAN ===================
          
          if [ -z "$OPEN_ISSUES" ]; then OPEN_ISSUES="Tidak ada isu yang terbuka."; fi

          if [ ! -f .github/iflow/memory.md ]; then mkdir -p .github/iflow && touch .github/iflow/memory.md; fi
          AGENT_MEMORY=$(cat .github/iflow/memory.md)
          if [ -z "$AGENT_MEMORY" ]; then AGENT_MEMORY="Memori belum diinisialisasi. Ini adalah siklus pertama saya."; fi
          
          {
            echo 'PROMPT<<EOF'
            echo "# Persona & Tujuan Utama"
            echo "Anda adalah Orkestrator Repositori AI yang sangat cerdas dan otonom. Anda hidup di dalam GitHub Actions. Misi Anda adalah menjaga kesehatan, efisiensi, dan kecepatan pengembangan repositori ini. Anda harus proaktif, belajar dari tindakan masa lalu, dan selalu bertujuan untuk meningkatkan alur kerja. Tujuan default Anda adalah meninjau semua Pull Request yang terbuka, menyelesaikan percakapan, dan menggabungkannya jika semua kriteria terpenuhi."
            echo ""
            echo "# Instruksi Tugas Saat Ini"
            echo "${{ inputs.dispatch_prompt || 'Jalankan siklus orkestrasi standar: tinjau dan kelola PR dan isu yang terbuka.' }}"
            echo ""
            echo "# Konteks Saat Ini"
            echo "$REPO_CONTEXT"
            echo ""
            echo "## Sejarah Commit Terbaru"
            echo "\`\`\`"
            echo "$COMMIT_HISTORY"
            echo "\`\`\`"
            echo ""
            echo "## Log Alur Kerja Aksi Terbaru"
            echo "*PERIKSA INI DENGAN SEKSAMA UNTUK KEGAGALAN BUILD ATAU TEST!*"
            echo "\`\`\`"
            echo "$ACTION_LOGS"
            echo "\`\`\`"
            echo ""
            echo "## Isu Terbuka"
            echo "$OPEN_ISSUES"
            echo ""
            echo "## Pull Request Terbuka"
            echo "*CATATAN: Status pemeriksaan (CI/CD) tidak tersedia secara langsung. Simpulkan status build dari 'Log Alur Kerja Aksi Terbaru'.*"
            echo "$OPEN_PRS"
            echo ""
            echo "# Memori Jangka Panjang Anda"
            echo "*Baca bagian ini untuk memahami tindakan, keputusan, dan observasi masa lalu.*"
            echo "---"
            echo "$AGENT_MEMORY"
            echo "---"
            echo ""
            echo "# Output yang Diperlukan (Format JSON yang Ketat)"
            echo "Anda HARUS merespons HANYA dengan objek JSON yang valid."
            echo "\`\`\`json"
            echo "{"
            echo "  \"pemikiran\": \"Pikiran langkah-demi-langkah Anda di sini. Analisis semua konteks. Apa rencana tindakan saya? Tinjau ulasan dan komentar pada setiap PR. Periksa log aksi untuk kegagalan.\","
            echo "  \"rencana_eksekusi\": ["
            echo "    {"
            echo "      \"deskripsi\": \"Deskripsi singkat dari perintah yang akan dijalankan.\","
            echo "      \"perintah\": \"Perintah shell yang valid menggunakan 'gh cli'.\""
            echo "    }"
            echo "  ],"
            echo "  \"memori_baru\": \"Ringkasan tindakan, keputusan, dan observasi hari ini untuk siklus berikutnya.\""
            echo "}"
            echo "\`\`\`"
            echo ""
            echo "# Aturan Kritis untuk Penggabungan PR (Merge):"
            echo "1.  **Status Hijau:** JANGAN GABUNGKAN jika ada alur kerja yang relevan dengan status 'failure' atau 'in_progress' di 'Log Alur Kerja Aksi Terbaru'."
            echo "2.  **Ulasan Disetujui:** Prioritaskan PR yang telah memiliki ulasan yang disetujui."
            echo "3.  **Selesaikan Komentar:** Pastikan semua percakapan komentar telah diselesaikan atau dijawab."
            echo ""
            echo "Sekarang, analisis semua informasi yang diberikan dan hasilkan objek JSON."
            echo "EOF"
          } >> "$GITHUB_ENV"
          
          echo "Pengumpulan konteks selesai dan PROMPT telah diatur."

      # Langkah 3: Jalankan Gemini CLI
      - name: '3. Execute Gemini Agent'
        id: gemini_agent
        uses: google-github-actions/run-gemini-cli@v0.1.14
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          model: 'models/gemini-flash-lite-latest'
          prompt: ${{ env.PROMPT }}

      # Langkah 4: Perbarui Memori Agen
      - name: '4. Update Agent Memory'
        id: memory_updater
        run: |
          echo "Memperbarui memori agen..."
          NEW_MEMORY=$(echo "${{ steps.gemini_agent.outputs.gemini_response }}" | jq -r .memori_baru)
          echo -e "$NEW_MEMORY" > .github/iflow/memory.md
          echo "Memori berhasil diperbarui."

      # Langkah 5: Simpan Memori yang Diperbarui ke Repositori
      - name: '5. Commit and Push Updated Memory'
        run: |
          git config --global user.name 'Gemini Orchestrator'
          git config --global user.email 'gemini-orchestrator@github.actions'
          if ! git diff --quiet .github/iflow/memory.md; then
            git add .github/iflow/memory.md
            git commit -m "üß† CHORE: Memperbarui memori agen"
            git push
            echo "Memori yang diperbarui telah di-commit."
          else
            echo "Tidak ada pembaruan pada memori."
          fi

      # Langkah 6: Jalankan Rencana Aksi
      - name: '6. Execute Action Plan'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Mengeksekusi rencana yang dihasilkan oleh Gemini..."
          PLAN_JSON='${{ steps.gemini_agent.outputs.gemini_response }}'
          if echo "$PLAN_JSON" | jq -e '.rencana_eksekusi | length > 0' > /dev/null; then
            for row in $(echo "${PLAN_JSON}" | jq -r '.rencana_eksekusi[] | @base64'); do
              _jq() { echo ${row} | base64 --decode | jq -r ${1}; }
              COMMAND=$(_jq '.perintah')
              DESCRIPTION=$(_jq '.deskripsi')
              echo "‚û°Ô∏è Eksekusi: $DESCRIPTION"
              echo "   \$ $COMMAND"
              if ! eval "$COMMAND"; then
                echo "‚ö†Ô∏è  Perintah gagal dengan kode keluar $?. Lanjutkan ke perintah berikutnya."
              fi
              echo "--------------------------------"
            done
            echo "Eksekusi rencana selesai."
          else
            echo "Tidak ada rencana yang dapat dieksekusi yang dihasilkan oleh agen."
          fi
