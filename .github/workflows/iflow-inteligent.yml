name: "ðŸ§  iflow intelijen adaptif"

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  gather_data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch GitHub Actions run history
        run: |
          mkdir -p intel
          gh run list --limit 100 --json number,workflowName,conclusion,createdAt,startedAt,updatedAt,status > intel/gha_runs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch recent open issues
        run: |
          gh issue list --state open --limit 200 --json number,title,labels,createdAt,updatedAt > intel/open_issues.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch recent PR history
        run: |
          gh pr list --state all --limit 200 --json number,title,mergedAt,createdAt,closedAt,author > intel/recent_prs.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload collected data
        uses: actions/upload-artifact@v4
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: intel/

  analyse_and_create_issues:
    needs: gather_data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download data artifacts from this run
        uses: actions/download-artifact@v4
        with:
          name: repo-intel-data-${{ github.run_id }}
          path: ./intel

      - name: Download previous self-improvement plan
        id: prev_plan
        run: |
          mkdir -p intel/prev_plan
          LATEST=$(gh run list --workflow "ðŸ§  iflow intelijen adaptif" --json databaseId,status -L 10 | \
                   jq '.[] | select(.status=="completed") | .databaseId' | head -n 1)
          if [ -n "$LATEST" ]; then
            gh run download $LATEST --name "self-improvement" --dir intel/prev_plan || echo "No previous plan"
          fi

      - name: Run iFlow CLI Agent for analysis and top-issue creation
        uses: iflow-ai/iflow-cli-action@v2.1.0
        with:
          api_key: ${{ secrets.IFLOW_API_KEY }}
          timeout: "7200"
          prompt: |
            ## ROLE
            You are an adaptive GitHub repository intelligence agent with write-access.

            ## CONTEXT
            - Repository: ${{ github.repository }}
            - CI/CD runs data: ./intel/gha_runs.json
            - Open issues data: ./intel/open_issues.json
            - PR history data: ./intel/recent_prs.json
            - Previous self-improvement plan (if exists): ./intel/prev_plan
            - Full repository code base is checked-out and available for deep analysis

            ## TASKS
            1. Deeply analyze the codebase: modules, dependencies, documentation, test coverage gaps, duplication, naming inconsistencies.
            2. Analyze CI/CD logs: identify jobs with frequent failures, long durations (>10 minutes), reruns, unstable workflows.
            3. Analyze issue/PR history: stale issues (open >60 days), PRs closed without merge, recurring bug patterns.
            4. Generate findings:
               - Bugs/inefficiencies (with description, location, impact)
               - Improvement opportunities (with gap and suggestion)
               - Feature ideas (at least two) with value proposition, rough implementation steps, estimated effort/impact
            5. Select the **single most important finding** (highest priority/impact) and create one GitHub Issue only.
            6. For improvement requiring workflow/config change: output unified-diff snippet targeting `.github/workflows/` or config files and commit or open PR if safe.
            7. Self-improvement plan:
               - Adjust thresholds, data to collect, or prompt refinements based on previous plan
               - Save final plan to `intel/self_improvement_plan.json`

            ## RULES
            - Do not expose or log any secrets.
            - Only create **one GitHub Issue** for the most critical finding.
            - All code changes (issue creation, patches) must be small, atomic, maintainable.

      - name: Upload self-improvement plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: self-improvement-${{ github.run_id }}
          path: intel/self_improvement_plan.json
